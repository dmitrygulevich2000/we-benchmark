## we-benchmark

Бенчмарки и эксперименты с исполнением контрактов в сети Waves Enterprise, выполненные при исследовании параллельного исполнения транзакций в блокчейне.

Сеть разворачивалась локально с использованием `docker-compose`. Все настройки можно найти в `network/`. Из ключевого можно отметить:
* 3 ноды - 1 из них с ролью `miner`, и в некоторых экспериментах ещё 1 с ролью `contract_validator`;
* время формирования блока - 8с;
* настроена отправка метрик;
* параметр `contracts-parallelism` меняется в зависимости от эксперимента.

Для удобного взаимодействия с сетью написана небольшая библиотека на JS в `operation/` и скрипты рядом с каждым смарт-контрактом в `contracts/`.

### Эксперименты

Для docker-смарт-контрактов были получены сценарии, в которых возникает:
* [MVCC-конфликт](contracts/counter-docker/scripts/test_mvcc_conflict.js)
* [ошибка валидации](contracts/counter-docker/scripts/test_validation_error.js)  
  требует правильной настройки sleep'ов в контейнерах

### Бенчмарки

Для проведения бенчмарков JS-скрипт отправлял в сеть некоторое число транзакций, вызывающих функции docker-смарт-контракта.  
Производительность оценивалась по количеству транзакций в блоке, которое смогла включить сеть (усреднённое по блокам "принявшим на себя" нагрузку).

Для моделирования конкурентности между транзакциями, они распределялись между маленьким (высокая конкурентность) или большим (низкая конкурентность) числом идентичных смарт-контрактов.

Сравнивались варианты с параллелизмом исполнения транзакций 1,2,4,8, в разных конфигурациях:
* быстрые транзакции - инкремент 1 значения;
* транзакции, много работающие с состоянием - 9 чтений, 8 записей;
* быстрые транзакции при включённой валидации

На графиках ниже изображена засимость размера блока(производительность) от числа транзакций на 1 смарт-контракт(конкурентность). Также, есть графики доли MVCC-конфликтов / ошибок валидации от всех исполнений контракта.

#### Быстрые транзакции

Нагрузка - 5 000 транзакций. Метод `light_increment` у Counter контракта `contracts/counter-docker/`.

![bench-fast_txs_valid_off](artifacts/bench%20-%20fast_txs_valid_off.png)

#### Читающие-пишущие транзакции

Нагрузка - 2 000 транзакций. Метод `add` у CumSums контракта `contracts/cumsums-docker/`.

![bench-rwintense_txs_valid_off](artifacts/bench%20-%20rwintense_txs_valid_off.png)

#### Быстрые транзакции, валидация

Нагрузка - 1 600 транзакций. Здесь транзакции отправлялись в сеть конкурентно.

![bench-fast_txs_valid_on](artifacts/bench%20-%20fast_txs_valid_on.png)
